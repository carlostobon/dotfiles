#!/bin/bash

function mutate_index(){
  # Checks if at leas two args were passed.
  if [ "$#" -lt 2 ]; then
      echo >&2 "Error: This function requires at least two arguments."
      exit 1
  fi

  # Checks if pnpm is installed
  if ! [ -x "$(command -v pnpm)" ]; then
    echo >&2 "Error: pnpm is not installed."
    exit 1
  fi

  # Checks if fd is installed
  if ! [ -x "$(command -v fd)" ]; then
    echo >&2 "Error: fd is not installed."
    exit 1
  fi


  # Run the command
  pnpm dlx shadcn-ui@latest add "$@"

  # Removes the first arg
  shift

  # Collect env var $ROOT
  if [ -z "$ROOT" ]; then
    echo >&2 "ROOT is not set." && exit 1
  else
    component_address="$ROOT/components/ui"
    index_address="$ROOT/components/ui/index.ts"
  fi

  # Attempt to create component directory
  if ! [ -e "$component_address" ]; then
    mkdir -p "$component_address" ||
      (echo "Couln't create $component_address" >&2 && exit 1)
  fi

  cd "$component_address" ||
    (echo >&2 "Couldn't cd to $component_address" && exit 1)

  content=$(fd .tsx --exec echo 'export * from "{}";' | sed 's/.tsx//g')
  echo "$content" > "$index_address"

}


if [[ "$1" == "add" ]]; then
  # It runs just when add is used.
  mutate_index "$@"
else
  # Otherwise regular approach is used.
  pnpm dlx shadcn-ui@latest "$@"
fi
